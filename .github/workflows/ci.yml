name: ci

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  check:
    name: check
    runs-on: ${{ matrix.platform }}

    strategy:
      fail-fast: false
      # matrix:
      #   platform: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Nix
      uses: nixbuild/nix-quick-install-action@v28

    - name: Cache Nix store
      uses: actions/cache@v4
      with:
        path: |
          /nix/store
          ~/.cache/nix
        key: ${{ runner.os }}-nix-${{ hashFiles('flake.lock') }}
        restore-keys: |
          ${{ runner.os }}-nix-

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          core/target
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-${{ hashFiles('core/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Cache frontend dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          frontend/.svelte-kit
          ~/.bun/install/cache
        key: ${{ runner.os }}-frontend-${{ hashFiles('frontend/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-frontend-

    - name: Install nix dependencies
      run: nix develop --command true

    - name: Run checks
      run: nix develop --command just check

    # - name: Build Tauri app
    #   run: nix develop --command just build
